name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build Release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            cross_image: ghcr.io/cross-rs/x86_64-unknown-linux-gnu:main
          - target: aarch64-unknown-linux-gnu
            cross_image: ghcr.io/cross-rs/aarch64-unknown-linux-gnu:main

    steps:
      - uses: actions/checkout@v4

      # Set up Rust
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          target: ${{ matrix.target }}

      # Install cross
      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      # Create Cross.toml config with CUPS installation
      - name: Configure cross
        run: |
          cat > Cross.toml << 'EOF'
          [target.x86_64-unknown-linux-gnu]
          image = "ghcr.io/cross-rs/x86_64-unknown-linux-gnu:main"
          pre-build = [
            "apt-get update && apt-get install -y libcups2-dev"
          ]

          [target.aarch64-unknown-linux-gnu]
          image = "ghcr.io/cross-rs/aarch64-unknown-linux-gnu:main"
          pre-build = [
            "dpkg --add-architecture arm64 && apt-get update && apt-get install -y libcups2-dev:arm64"
          ]

          [build.env]
          passthrough = [
            "OPENSSL_DIR",
            "OPENSSL_INCLUDE_DIR",
            "OPENSSL_LIB_DIR",
            "SSL_CERT_FILE",
            "SSL_CERT_DIR",
            "OPENSSL_STATIC",
            "OPENSSL_NO_VENDOR"
          ]
          EOF

      # Prepare Cargo.toml for pure vendored builds
      - name: Update Cargo.toml with vendored features
        run: |
          # Use 'native-tls-vendored' feature for reqwest
          sed -i 's/reqwest = { version = "0.12", features = \["json"\]/reqwest = { version = "0.12", features = \["json", "native-tls-vendored"\]/g' Cargo.toml
          
          # Set openssl-sys to use vendored feature
          if ! grep -q "openssl-sys" Cargo.toml; then
            echo 'openssl-sys = { version = "0.9", features = ["vendored"] }' >> Cargo.toml
          fi
          
          # Create feature for vendored-openssl if it doesn't exist
          if ! grep -q "\[features\]" Cargo.toml; then
            echo -e "\n[features]\ndefault = []\nvendored-openssl = [\"openssl-sys/vendored\"]" >> Cargo.toml
          elif ! grep -q "vendored-openssl" Cargo.toml; then
            sed -i '/\[features\]/a vendored-openssl = [\"openssl-sys/vendored\"]' Cargo.toml
          fi
          
          # Modify reverb-rs to use native-tls-vendored if available
          if grep -q "reverb-rs.*native-tls" Cargo.toml; then
            sed -i 's/reverb-rs.*native-tls/reverb-rs = { git = "https:\/\/github.com\/Team-Nifty-GmbH\/reverb_rs", branch = "main", default-features = false, features = ["native-tls-vendored"] }/g' Cargo.toml
          fi
          
          # Show the updated Cargo.toml
          cat Cargo.toml

      # Build with cross
      - name: Build with cross
        run: |
          # Set environment variables
          export OPENSSL_STATIC=1
          export PKG_CONFIG_ALLOW_CROSS=1
          
          # Build with verbose output to diagnose any issues
          RUST_BACKTRACE=1 cross build --target ${{ matrix.target }} --release --features vendored-openssl -vv
          
          # Check if build succeeded
          if [ -f "target/${{ matrix.target }}/release/nuxbe-printer-bridge" ]; then
            echo "Build successful!"

            # Package the binary
            mkdir -p artifacts
            cd target/${{ matrix.target }}/release
            tar czvf ../../../artifacts/nuxbe-printer-bridge-${{ matrix.target }}.tar.gz nuxbe-printer-bridge
            cd -
          else
            echo "Build failed!"
            find target -type f -name "nuxbe-printer-bridge" || true
            exit 1
          fi

      # Upload artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuxbe-printer-bridge-${{ matrix.target }}
          path: artifacts/nuxbe-printer-bridge-${{ matrix.target }}.tar.gz
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all workflow run artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: find artifacts -type f | sort

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/nuxbe-printer-bridge-x86_64-unknown-linux-gnu/nuxbe-printer-bridge-x86_64-unknown-linux-gnu.tar.gz
            artifacts/nuxbe-printer-bridge-aarch64-unknown-linux-gnu/nuxbe-printer-bridge-aarch64-unknown-linux-gnu.tar.gz
          generate_release_notes: true